Add-Type -AssemblyName System.Windows.Forms
$title = "Skript Läuft"
$popupMessage = "Impero wird jetzt beendet"

$trayIcon = New-Object System.Windows.Forms.NotifyIcon
$trayIcon.Icon = [System.Drawing.SystemIcons]::Information  # Standard-Icon (Information)
$trayIcon.Visible = $true

$contextMenu = New-Object System.Windows.Forms.ContextMenu
$exitMenuItem = New-Object System.Windows.Forms.MenuItem "Beenden"
$contextMenu.MenuItems.Add($exitMenuItem)

$exitMenuItem.Add_Click({
    # Dialog beim Schließen des Skripts
    [System.Windows.Forms.MessageBox]::Show("Beendet", "Job beendet", [System.Windows.Forms.MessageBoxButtons]::OK)
    
    # Beenden des Tray-Icons
    $trayIcon.Visible = $false
    
    # Setze das Flag auf false, um die Endlosschleife zu stoppen
    $global:stopFlag = $true

    # Stoppen des Hintergrundjobs und der Anwendung
    $global:job | Stop-Job
    [System.Windows.Forms.Application]::Exit()  # Beendet das Skript
})

$trayIcon.ContextMenu = $contextMenu

function Show-Icon {
    [System.Windows.Forms.Application]::Run()  # Wartet auf Events
}

$global:job = Start-Job -ScriptBlock { 
    Show-Icon
} | Out-Null  # Verhindert die Ausgabe des Jobs in der Konsole

$global:stopFlag = $false

while (-not $global:stopFlag) {
    $process = Get-Process -Name "backdropclient" -ErrorAction SilentlyContinue
    if ($process) {
        Stop-Process -Name "backdropclient" -Force
    }
    Start-Sleep -Milliseconds 500
}
Exit

